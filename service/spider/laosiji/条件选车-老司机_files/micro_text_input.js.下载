var microTextInput = function(microTextRes, isLoadCommunity) {
	//发布文章接口
	var postUrl = microTextRes && microTextRes.isDiscuss ? '/snsautodiscuss/addautodiscuss' : '/api/sns/addvv';
	var pubFlag = true;
	var imageUpload, videoUpload, multiFlag = false;
	if (microTextRes) {
		multiFlag = true;
	}
	var isOnce = true; //打开发布框第一次点击圈子发布
	//发微文编辑器html
	function buildHtml(html) {
		var microTextInputBox = document.createElement('div');
		microTextInputBox.className = 'microTextInput-box';
		//发帖结构
		var microTextInputContainer = document.createElement('div');
		microTextInputContainer.className = 'microTextInput-container';
		//textarea
		var inputC = document.createElement('div');
		inputC.className = 'input-area';
		var input = document.createElement('textarea');
		inputC.appendChild(input);
		input.className = input.id = 'microTextInput-textarea';
		input.setAttribute('placeholder', '此时此刻我想说');
		//上传图片按钮
		var upImgBtn = document.createElement('a');
		upImgBtn.setAttribute('href', 'javascript:;');
		upImgBtn.className = upImgBtn.id = 'microTextInput-upImgBtn';
		upImgBtn.innerHTML = '<i></i>图片';
		var upImgBtnC = document.createElement('span');
		upImgBtnC.style.display = 'inline-block';
		upImgBtnC.appendChild(upImgBtn);
		//上传视频按钮
		var upVideoBtn = document.createElement('a');
		upVideoBtn.setAttribute('href', 'javascript:;');
		upVideoBtn.className = upVideoBtn.id = 'microTextInput-upVideoBtn';
		upVideoBtn.innerHTML = '<i></i>视频';
		var upVideoBtnC = document.createElement('span');
		upVideoBtnC.style.display = 'inline-block';
		upVideoBtnC.style.position = upImgBtnC.style.position = 'relative';
		upVideoBtnC.appendChild(upVideoBtn);
		//插入表情按钮
		var faceBtn = document.createElement('a');
		faceBtn.setAttribute('href', 'javascript:;');
		faceBtn.className = faceBtn.id = 'microTextInput-faceBtn';
		faceBtn.id = 'microTextInput-faceBtn';
		faceBtn.innerHTML = '<i></i>表情';
		Od.PopLayer({
			arrow: true,
			id: faceBtn.getAttribute('id'),
			target: faceBtn,
			zIndex: 1002,
			method: 'click',
			html: function(popContent) {
				var faceContainer = document.createElement('div');
				faceContainer.className = 'custom-face-container';
				for (var i = 1, len = 60; i <= len; i++) {
					if (i < 10) {
						i = '0' + i;
					}
					var a = document.createElement('a');
					a.href = 'javascript:;';
					a.setAttribute('faceStr', '[5X:01' + i + ']'); //加载表情编码
					a.onclick = function() {
						Od.InsertFace(this, input); //插入表情转义
					}
					a.innerHTML = Od.TransText({
						text: '[5X:01' + i + ']'
					}); //编码转表情图
					faceContainer.appendChild(a);
				}
				popContent.appendChild(faceContainer);
			}
		});
		//长文章按钮
		var articleBtn = document.createElement('a');
		articleBtn.setAttribute('href', '/thread/input');
		if (microTextRes != undefined && microTextRes.isCommunity) {
			articleBtn.setAttribute('href', '/thread/input?communityid=' + microTextRes.communityId);
		}
		articleBtn.setAttribute('target', '_blank');
		articleBtn.className = articleBtn.id = 'microTextInput-articleBtn';
		articleBtn.innerHTML = '<i></i>长文章';
		//计数
		var countDom = document.createElement('span');
		countDom.className = 'micro-text-input-count';
		countDom.id = 'microTextInputCount';
		//发布按钮
		var pubMicroTextBtn = document.createElement('a');
		pubMicroTextBtn.setAttribute('href', 'javascript:;');
		pubMicroTextBtn.className = 'microTextInput-pubMicroTextBtn';
		pubMicroTextBtn.innerHTML = '发布';
		pubMicroTextBtn.onclick = function() {
			if (pubFlag) {
				if (microTextRes != undefined && microTextRes.isThread) {
					pubSnsThread();
				} else {
					pubSns();
				}
			}
		};
		//按钮区域
		var actionsDiv = document.createElement('div');
		actionsDiv.className = 'microTextInput-actions';
		var btnArea = document.createElement('div'); //按钮
		btnArea.className = 'microTextInput-btnArea';
		btnArea.style.position = 'relative';
		btnArea.appendChild(faceBtn);
		if (!microTextRes || !microTextRes.isThread) { //非帖子摘要
			btnArea.appendChild(upImgBtnC);
			if (!microTextRes || !microTextRes.isDiscuss) { //非观点
				btnArea.appendChild(upVideoBtnC);
				btnArea.appendChild(articleBtn);
			}
		} else { //帖子摘要
			actionsDiv.className = 'microTextInput-actions microTextInput-thread-actions';
			input.setAttribute('placeholder', '来为《' + microTextRes.theadTitle + '》写段摘要吧');
		}
		btnArea.appendChild(countDom);
		//圈子
		var btnComm = document.createElement('div');
		btnComm.className = 'microTextInput-btnComm';
		btnComm.style.position = 'relative';
		btnComm.innerHTML = '<h5>同时分享到圈子<img src="http://imageqiniu.xxxxxbbs.com/FtnIcpZhPibAmkwAifrLXELPDGoa"/></h5>' +
			'<p id="microSelectCommunityText">分享到圈子可以提高内容曝光哦</p><i class="commuinty-add">+</i>';
		btnComm.onclick = function() {
			gotoMicroCoumminty();
		}
		microTextInputContainer.appendChild(inputC);
		actionsDiv.appendChild(btnArea);
		actionsDiv.appendChild(btnComm);
		microTextInputContainer.appendChild(actionsDiv);
		microTextInputContainer.appendChild(pubMicroTextBtn); //发布按钮
		microTextInputBox.appendChild(microTextInputContainer);
		//圈子结构
		var communityContainer = document.createElement('div');
		communityContainer.className = 'microTextInput-community hide';
		var communitySearchBox = document.createElement('div'); //圈子搜索
		communitySearchBox.className = 'microTextInput-comm-searchBox';
		var communitySearchDiv = document.createElement('div');
		communitySearchDiv.className = 'microTextInput-comm-search';
		var communitySearchCont = document.createElement('div');
		communitySearchCont.className = 'microTextInput-comm-searchContent';
		communitySearchCont.innerHTML = '<img src="http://imageqiniu.xxxxxbbs.com/FiOZOkhnjnBFmM4GmFPsuhJMRzuF" />'
		var communitySearchInput = document.createElement('input');
		communitySearchInput.id = 'microCommunitySearch';
		communitySearchInput.placeholder = '请输入搜索关键字';
		communitySearchInput.onfocus = function() {
			document.onkeydown = function(event) {
				if (event.keyCode == 13) {
					isSearchOpen = true;
					microSearchCoummunity(1);
					return false;
				}
			}
		}
		var communitySearchReturn = document.createElement('a');
		communitySearchReturn.className = 'microTextInput-comm-searchBtn hide';
		communitySearchReturn.innerHTML = '返回';
		communitySearchReturn.onclick = function() {
			isSearchOpen = false;
			communitySearchReturn.className = 'microTextInput-comm-searchBtn hide';
			communitySearchInput.value = '';
			if (communityDataOldArr.length != 0) {
				communityDataArr = communityDataOldArr.slice(0);
			}
			microSortCommunityData();
			microCommunityItem();
		}
		communitySearchCont.appendChild(communitySearchInput);
		communitySearchDiv.appendChild(communitySearchCont);
		communitySearchDiv.appendChild(communitySearchReturn);
		communitySearchBox.appendChild(communitySearchDiv);
		communityContainer.appendChild(communitySearchBox);

		var communityAddBox = document.createElement('div');
		communityAddBox.className = 'microTextInput-comm-addBox';
		communitySearchBox.appendChild(communityAddBox);

		var communityResultScroll = document.createElement('div');
		communityResultScroll.className = 'microTextInput-comm-resultScroll';
		var communityResultBox = document.createElement('div'); //圈子搜索结果
		communityResultBox.className = 'microTextInput-comm-resultBox';
		communityContainer.appendChild(communityResultScroll).appendChild(communityResultBox);
		var communityResultAction = document.createElement('div');
		communityResultAction.className = 'microTextInput-comm-action';
		communityResultAction.id = 'microTextInputCommAction';
		var communityResultSubmit = document.createElement('a');
		communityResultSubmit.className = 'microTextInput-comm-submit';
		communityResultSubmit.href = 'javascript:;';
		communityResultSubmit.innerHTML = '确定（<span id="microTextInputAllowNum">0</span>/3）';
		communityResultSubmit.onclick = function() {
			communitySearchReturn.click();
			gobackMicroText();
			setSelectCommunityText();
		}
		var communityResultHint = document.createElement('a');
		communityResultHint.className = 'microTextInput-comm-hint';
		communityResultHint.href = 'javascript:;';
		communityResultHint.innerHTML = '没想好分享到什么圈子，返回';
		communityResultHint.onclick = function() {
			if (communitySelectArr.length > 0) {
				communitySearchReturn.click();
				gobackMicroText();
				setSelectCommunityText();
			} else {
				gobackMicroText();
			}
		}
		communityResultAction.appendChild(communityResultSubmit);
		communityContainer.appendChild(communityResultAction).appendChild(communityResultHint);
		microTextInputBox.appendChild(communityContainer);
		return microTextInputBox;
	};
	//圈子  
	var communityData = new Object; //圈子列表数据(用于去重)(第一次请求的)
	var communityDataArr = []; //圈子列表数据(用于循环列表)
	var communityDataOldArr = []; //圈子列表数据(用于储存)
	var communitySelect = new Object; //圈子选中数据(用于去重)
	var communitySelectArr = []; //圈子选中数据(用于循环列表)
	var communityCount = 0; //圈子个数
	var communityAllow = 0; //圈子允许个数
	var isSearchOpen = false; //是否正在搜索 
	//清空圈子列表数据
	function microClearCommunity() {
		communityDataOldArr = communityDataArr.slice(0);
		communityDataArr.length = 0;
	}
	//打开圈子
	function gotoMicroCoumminty() {
		document.querySelector('.microTextInput-container').className = 'microTextInput-container hide';
		document.querySelector('.microTextInput-community').className = 'microTextInput-community';
		if (isOnce) {
			//			var loading = document.createElement('div');
			//			loading.style.position = 'absolute';
			//			loading.style.top = '150px';
			//			loading.style.left = '360px';
			//			loading.style.textAlign = 'center';
			//			loading.className = 'micro-loading';
			//			loading.innerHTML = '<img src="/new_web/static/images/loading.gif"/>';
			//			document.querySelector('.microTextInput-community').appendChild(loading);
			//			microAddCommunity();
			//			microDetailsAddCommunity();
			isOnce = false;
		} else {
			microSortCommunityData();
			microCommunityItem();
			microCommunityAddItem(communitySelectArr);
			Od.CustomScroll({
				target: 'microTextInput-comm-resultScroll',
				height: 478,
				width: 754,
				barWidth: 5
			});
		}
	}
	//返回发帖
	function gobackMicroText() {
		document.getElementById("microSelectCommunityText").innerHTML = '分享到圈子可以提高内容曝光哦';
		document.querySelector('.microTextInput-container').className = 'microTextInput-container';
		document.querySelector('.microTextInput-community').className = 'microTextInput-community hide';
	}
	//更新圈子文案
	function setSelectCommunityText() {
		var selectArr = [];
		for (var s in communitySelect) {
			selectArr.push(communitySelect[s].name);
		}
		document.getElementById("microSelectCommunityText").innerHTML = selectArr.join(',');
	}
	//检查是否选中圈子
	function checkSelectCommunity(data) {
		if (communitySelect[data.id] == undefined) {
			return false; //未选中
		} else {
			return true; //选中
		}
	}
	//已添加的圈子的排序提前
	function microSortCommunityData() {
		var csl = communitySelectArr.length;
		for (var i = 0; i < csl; i++) {
			var comData = communitySelectArr[i];
			var comId = comData.id;
			if (communityData[comId] != undefined) {
				var l = communityDataArr.length;
				for (var j = 0; j < l; j++) {
					if (communityDataArr[j].id == comId) {
						communityDataArr.splice(j, 1);
						break;
					}
				}
			}
			communityData[comId] = comData;
			communityDataArr.unshift(comData);
		}
	}
	//圈子列表数据更新
	function microSetCoummunityData(data, type) { //2头部添加
		var l = data.length;
		if (l > 0) {
			for (var i = 0; i < l; i++) {
				if (isSearchOpen) {
					communityDataArr.push(data[i]);
				} else {
					if (communityData[data[i].id] != undefined) continue;
					if (type == 2) {
						communityDataArr.unshift(data[i]);
					} else {
						communityDataArr.push(data[i]);
					}
					communityData[data[i].id] = data[i];
				}
			}
		}
	}
	//圈子选中数据更新
	function microSetCoummunitySelect(selectId, type) { //type 1添加 -1删除
		if (type == 1) {
			var l = communityDataArr.length;
			for (var i = 0; i < l; i++) {
				if (communityDataArr[i].id == selectId) {
					//					if(communityData[selectId] == undefined) {
					//						communityDataOldArr.unshift(communityDataArr[i]);
					//					}
					communitySelect[selectId] = communityDataArr[i]
					communitySelectArr.push(communityDataArr[i]);
					break;
				}
			}
		} else {
			delete communitySelect[selectId];
			var l = communitySelectArr.length;
			for (var i = 0; i < l; i++) {
				if (communitySelectArr[i].id == selectId) {
					communitySelectArr.splice(i, 1);
					//					if(isSearchOpen) {
					//						if(communityData[selectId] == undefined) {
					//							var jl = communityDataOldArr.length;
					//							for(var j = 0; j < jl; j++) {
					//								if(communityDataOldArr[j].id == selectId) {
					//									communityDataOldArr.splice(j, 1);
					//									break;
					//								}
					//							}
					//						}
					//					}
					break;
				}
			}
		}
		microCommunityAddItem(communitySelectArr);
	}
	//搜索圈子
	function microSearchCoummunity(page, type) {
		var search = document.getElementById("microCommunitySearch").value;
		Od.Ajax({
			method: "post",
			url: "/community/getmorelist",
			data: {
				'userId': document.getElementById("userid").value,
				'page': page,
				'search': search
			},
			asyc: false,
			success: function(res) {
				if (type != 'add') {
					microClearCommunity();
				}
				microSetCoummunityData(res.body.community.list);
				document.querySelector('.microTextInput-comm-searchBtn').className = 'microTextInput-comm-searchBtn';
				microCommunityItem();
				if (Number(res.body.community.pagecount) > page) {
					microSearchCoummunity(page + 1, 'add');
				}
			}
		});
	}
	//圈子列表dom
	function microCommunityItem() {
		var box = document.querySelector('.microTextInput-comm-resultBox');
		if (box != null) {

			box.innerHTML = ''
			communityCount = 0;
			for (var c in communityDataArr) {
				var communityResultItem = document.createElement('div');
				communityResultItem.className = 'microTextInput-comm-resultItem';
				if (communityCount % 2 == 1) {
					communityResultItem.className = 'microTextInput-comm-resultItem mr0';
				}
				communityResultItem.innerHTML = '<a href="javascript:;" class="comm-resultItem-img"><img src="' + communityDataArr[c].image.url + '?imageMogr2/auto-orient/thumbnail/!80x80r/gravity/Center/crop/80x80/quality/100"/></a>' +
					'<div class="comm-resultItem-info"><h4>' + communityDataArr[c].name + (communityDataArr[c].type == 0 ? ' 圈子' : '') + '</h4><p>' + communityDataArr[c].fanscount + '人加入 ' + communityDataArr[c].snscount + '条内容</p>'
				var communityResultBtn = document.createElement('div');
				communityResultBtn.className = 'comm-resultItem-actions';
				var communityResultCheckbox = document.createElement('input');
				communityResultCheckbox.type = 'checkbox';
				communityResultCheckbox.name = 'comm-resultItem-checkbox';
				communityResultCheckbox.value = communityDataArr[c].id;
				communityResultCheckbox.checked = checkSelectCommunity(communityDataArr[c]);
				(function() {
					communityResultCheckbox.onchange = function(e) {
						if (communityAllow >= 3 && e.currentTarget.checked) {
							e.currentTarget.checked = false;
							return false;
						}
						var selectId = e.currentTarget.value;
						if (e.currentTarget.checked) {
							communityAllow++;
							microSetCoummunitySelect(selectId, 1);
						} else {
							communityAllow--;
							microSetCoummunitySelect(selectId, -1);
						}
					}
				})(communityResultCheckbox)
				var communityResultI = document.createElement('i');
				communityResultBtn.appendChild(communityResultCheckbox);
				communityResultItem.appendChild(communityResultBtn).appendChild(communityResultI);
				box.appendChild(communityResultItem);
				communityCount++;
			}
		}
	}
	//圈子已添加dom
	function microCommunityAddItem(data) {
		var box = document.querySelector('.microTextInput-comm-addBox');
		if (box != null) {
			box.innerHTML = '';
			for (d in data) {
				var communityAddItem = document.createElement('div');
				communityAddItem.className = 'microTextInput-comm-addItem';
				communityAddItem.innerHTML = '<img src="' + data[d].image.url + '?imageMogr2/auto-orient/thumbnail/!70x70r/gravity/Center/crop/70x70/quality/100" />';
				var communityAddDeleteA = document.createElement('a');
				communityAddDeleteA.className = 'microTextInput-comm-addDelete';
				communityAddDeleteA.setAttribute('data-id', data[d].id);
				communityAddDeleteA.setAttribute('href', 'javascript:;');
				communityAddDeleteA.innerHTML = '<img src="http://imageqiniu.xxxxxbbs.com/FmtpxjKy8JENB_EUqrjg_ZlADOtp"/>';
				(function(communityAddDeleteA) {
					communityAddDeleteA.onclick = function() {
						communityAllow--;
						document.getElementById("microTextInputAllowNum").innerHTML = communityAllow;
						var deleteId = this.getAttribute('data-id');
						//					delete communitySelect[deleteId];
						microSetCoummunitySelect(deleteId, -1);
						if (document.querySelector('[name="comm-resultItem-checkbox"][value="' + deleteId + '"]') != null) {
							document.querySelector('[name="comm-resultItem-checkbox"][value="' + deleteId + '"]').checked = false;
						}
						microCommunityAddItem(communitySelect);
					}
				})(communityAddDeleteA);
				box.appendChild(communityAddItem).appendChild(communityAddDeleteA);
			}
			document.getElementById("microTextInputAllowNum").innerHTML = communityAllow;
		}
	}
	//添加圈子
	function microAddCommunity() {
		Od.Ajax({
			method: "post",
			url: "/community/getlist",
			data: {
				'userId': document.getElementById("userid").value,
				'page': 1,
				'pagesize': 50,
				'type': 3
			},
			asyc: true,
			success: function(res) {
				if (res.body.community != undefined) {
					microSetCoummunityData(res.body.community.list);
				}
				Od.Ajax({
					method: "post",
					url: "/community/getlist",
					data: {
						'userId': document.getElementById("userid").value,
						'page': 1,
						'pagesize': 50,
						'type': 1
					},
					asyc: true,
					success: function(res) {
						if (res.body.community != undefined) {
							microSetCoummunityData(res.body.community.list);
						}
						Od.Ajax({
							method: "post",
							url: "/community/getlist",
							data: {
								'userId': document.getElementById("userid").value,
								'page': 1,
								'pagesize': 50,
								'type': 2
							},
							asyc: true,
							success: function(res) {
								if (res.body.community != undefined) {
									microSetCoummunityData(res.body.community.list);
								}
								microSortCommunityData();
								microCommunityItem();
								microCommunityAddItem(communitySelectArr);
								Od.CustomScroll({
									target: 'microTextInput-comm-resultScroll',
									height: 478,
									width: 754,
									barWidth: 5
								});
								var loading = document.querySelector('.micro-loading');
								loading.parentNode.removeChild(loading);
								document.querySelector('.microTextInput-comm-resultScroll').style.opacity = 1;
							}
						});
					}
				});
			}
		});
	}
	//圈子详情页发帖
	function microDetailsAddCommunity() {
		if (microTextRes != undefined && microTextRes.isCommunity) { //圈子发帖
			var comId = microTextRes.communityId;
			Od.Ajax({
				method: 'post',
				url: '/community/getinfobyid',
				data: {
					'userId': document.getElementById("userid").value,
					'communityid': comId
				},
				asyc: false,
				success: function(res) {
					communityAllow = 1;
					communitySelect[comId] = res.body.community;
					communitySelectArr.unshift(res.body.community);
					microSortCommunityData();
					setSelectCommunityText();
				}
			})
		}
	}
	//图片上传-add
	function imgAdd(uploader, files) {
		var addBtn;
		var ul;
		var imgCount = 0;
		if (document.getElementById('OdPopLayer-microTextInput-upImgBtn')) {
			for (var j = 0, len = document.getElementById('OdPopLayer-microTextInput-upImgBtn').getElementsByTagName('li').length; j < len; j++) {
				if (document.getElementById('OdPopLayer-microTextInput-upImgBtn').getElementsByTagName('li')[j].id != 'dummy') {
					imgCount++;
				}
			}
		}
		var filesLength = files.length;
		if (imgCount + filesLength > 9) {
			for (var k = 0, len = filesLength + imgCount - 9; k < len; k++) {
				uploader.files.splice(files.length - 1, 1);
				files.splice(files.length - 1, 1);
			}
		}
		if (!document.getElementById('OdPopLayer-microTextInput-upImgBtn')) {
			Od.PopLayer({
				id: 'microTextInput-upImgBtn',
				arrow: true,
				zIndex: 1002,
				target: document.getElementById('microTextInput-upImgBtn'),
				method: 'handleClose-auto', //属性和值固定，添加此项则必须使用关闭按钮方可关闭浮层，关闭按钮自动生成，无需定义
				handleCloseText: '是否取消上传图片？',
				html: function(popContent) {
					ul = document.createElement('ul');
					ul.id = "microTextImgSort";
					ul.style.maxWidth = "285px";
					ul.style.overflow = "hidden";
					addBtn = document.createElement('a');
					addBtn.className = 'addBtn';
					addBtn.id = 'microTextImgSort-addMicroTextImgBtn';
					addBtn.innerHTML = '+';
					addBtn.setAttribute('style', 'display:block;float:left;width:79px;height:79px;line-height:79px;font-size:40px;color:#ccc;text-align:center;margin:10px 10px 0px 0px;border:3px dashed #ccc');
					addBtn.setAttribute('href', 'javascript:;');
					// if (!microTextRes || !microTextRes.isDiscuss) {
					ul.appendChild(addBtn);
					// }
					for (var i = 0, len = files.length; i < len; i++) {
						var li = document.createElement('li');
						li.style.float = 'left';
						li.style.width = '85px';
						li.style.height = '85px';
						li.style.textAlign = 'center';
						if (microTextRes && microTextRes.isDiscuss) {
							li.style.marginTop = "5px";
							li.style.marginRight = '0px';
						} else {
							li.style.marginTop = "10px";
							li.style.marginRight = '10px';
						}
						li.style.backgroundColor = "#f0f0f0";
						li.innerHTML = '<img src="/images/loading.gif" style="width:18px;height:18px;margin-top:34px;"/>';
						li.id = files[i].id;
						ul.insertBefore(li, addBtn);
					}
					popContent.appendChild(ul);
				},
				closeCallBack: function() { //关闭回调
					browseDisable('all');
				}
			});
			uploader.disableBrowse(true);
		} else {
			ul = document.getElementById('OdPopLayer-microTextInput-upImgBtn').getElementsByTagName('ul')[0];
			imgCount = ul.getElementsByTagName('li').length;
			addBtn = document.getElementById('microTextImgSort-addMicroTextImgBtn');
			for (var i = 0, len = files.length; i < len; i++) {
				var li = document.createElement('li');
				li.style.float = 'left';
				li.style.width = '85px';
				li.style.height = '85px';
				li.style.textAlign = 'center';
				if (microTextRes && microTextRes.isDiscuss) {
					li.style.marginTop = "5px";
					li.style.marginRight = '0px';
				} else {
					li.style.marginTop = "10px";
					li.style.marginRight = '10px';
				}
				li.style.backgroundColor = "#f0f0f0";
				li.innerHTML = '<img src="/images/loading.gif" style="width:18px;height:18px;margin-top:34px;"/>';
				li.id = files[i].id;
				ul.insertBefore(li, addBtn);
			}
		}
		if (ul.getElementsByTagName('li').length >= 9 || microTextRes && microTextRes.isDiscuss) {
			addBtn.style.display = 'none';
		}
		browseDisable('v');
	};
	//图片上传-loaded
	function imgLoaded(up, file, info) {
		info = eval('(' + info.response + ')');
		document.getElementById(file.id).innerHTML = '';
		var remove = document.createElement('a');
		remove.className = 'remove';
		remove.setAttribute('href', 'javascript:;');
		if (!microTextRes) {
			document.getElementById(file.id).appendChild(remove);
		}
		document.getElementById(file.id).appendChild(Od.ImageUrl({
			type: 1,
			w: 85,
			h: 85,
			gravity: 'Center',
			hash: info.hash
		}));
		var orient = info.orient;
		//判断图片方向
		if ("Right-top" == orient || "Left-top" == orient || "Right-bottom" == orient || "Left-bottom" == orient) {
			document.getElementById(file.id).setAttribute('w', info.h);
			document.getElementById(file.id).setAttribute('h', info.w);
		} else {
			document.getElementById(file.id).setAttribute('w', info.w);
			document.getElementById(file.id).setAttribute('h', info.h);
		}
		document.getElementById(file.id).setAttribute('fsize', info.fsize);
		document.getElementById(file.id).setAttribute('hash', info.hash);
		document.getElementById(file.id).setAttribute('url', info.hash);
		document.getElementById(file.id).setAttribute('mime', info.mimeType);
	};
	//图片上传-complete
	function imgCompleteFunc(uploader) {
		if (!microTextRes) {
			Od.Sortable({
				id: 'microTextImgSort',
				el: 'li',
				handleDom: 'remove',
				handleFunc: function(dom) {
					document.getElementById('microTextImgSort').removeChild(dom.parentNode);
					if (document.getElementById('microTextImgSort').getElementsByTagName('li').length < 9) {
						document.getElementById('microTextImgSort-addMicroTextImgBtn').style.display = 'block';
						if (document.getElementById('microTextImgSort').getElementsByTagName('li').length <= 0) {
							document.getElementById('OdPopLayer-microTextInput-upImgBtn').className = 'OdPopLayer';
							setTimeout(function() {
								document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upImgBtn'));
								imageUpload = Od.imageUpload({
									uploader: this,
									singleSelect: multiFlag,
									id: 'microTextInput-upImgBtn',
									fileAdd: function(up, files) {
										imgAdd(up, files);
									},
									fileLoaded: function(up, file, info) {
										imgLoaded(up, file, info);
									},
									fileComplete: function() {
										imgCompleteFunc(this.uploader);
									},
									upError: function() {
										videoUploadError(uploader);
									}
								});
							}, 200);

						}
					}
				}
			});
		}

		uploader.destroy();
		imgComplete();
	};
	//complete
	function imgComplete() {
		imageUpload = Od.imageUpload({
			uploader: this,
			singleSelect: multiFlag,
			id: 'microTextImgSort-addMicroTextImgBtn',
			fileAdd: function(up, files) {
				imgAdd(up, files);
			},
			fileLoaded: function(up, file, info) {
				imgLoaded(up, file, info);
			},
			fileComplete: function() {
				imgCompleteFunc(this.uploader);
			}
		});
	};
	//视频上传重置
	function videoUploadReload(uploader) {
		document.getElementById('microTextInput-upImgBtn').onclick = '';
		uploader.destroy();
		videoUpload = Od.videoUpload({
			uploader: this,
			id: 'microTextInput-upVideoBtn',
			fileAdd: function(up, files) {
				videoAdd(up, files)
			},
			fileProgress: function(up, file) {
				videoProgress(up, file);
			},
			fileLoaded: function(up, file, info) {
				videoLoaded(up, file, info);
			},
			upError: function() {
				videoUploadError(uploader);
			}
		});
		imageUpload.disableBrowse(false);
	};
	//视频上传报错
	function videoUploadError(uploader) {
		Od.Alert({
			html: '上传出现问题，点击“确定”尝试重新连接服务器。',
			callBack: function() {
				uploader.stop();
				uploader.start();
			}
		})
	};
	//视频上传-add
	function videoAdd(uploader, files) {
		Od.PopLayer({
			id: 'microTextInput-upVideoBtn',
			arrow: true,
			zIndex: 1002,
			target: document.getElementById('microTextInput-upVideoBtn'),
			method: 'handleClose-auto', //属性和值固定，添加此项则必须使用关闭按钮方可关闭浮层，关闭按钮自动生成，无需定义
			handleCloseText: '是否取消上传视频？',
			html: function(popContent) {
				var videoBox = document.createElement('div');
				videoBox.innerHTML = '<h3 id="videoUploadPercentage" style="font-size:36px;margin-top:30px;margin-bottom:10px;color:#ffb90a;font-weight:300;text-align:center;">0%</h3><h4 style="text-align:center;font-size:14px;color:#999;margin:10px 0px 20px">正在处理视频，请您稍等...</h4><div style="display:block;position:relative;width:260px;height:13px;background:#f1f1f1;border-radius:7px;margin-bottom:5px;"><div id="videoUploadProgress" style="position:aboslute;height:13px;background:#ffb90a;border-radius:7px;transition:width 0.2s ease-out;width:0%"></div></div>';
				var speedDom = document.createElement('span');
				speedDom.id = "microTextUploadVideoSpeed";
				speedDom.innerHTML = '(<em style="color:#ffb90a">0</em><i>/s</i>)';
				speedDom.style.color = '#ccc';
				speedDom.style.marginBottom = '20px';
				speedDom.style.display = 'block';
				speedDom.style.textAlign = 'center';
				var cancelBtn = document.createElement('a');
				cancelBtn.className = 'cancel-upload-video-btn';
				cancelBtn.setAttribute('href', 'javascript:;');
				cancelBtn.innerText = '取消';
				cancelBtn.onclick = function(e) {
					Od.Alert({
						html: '是否取消上传视频？', //弹出框html
						cancelBtn: true, //是否显示取消按钮，默认false，可不加。
						target: Od.Target(e), //触发此事件按钮
						callBack: function() { //点击确定的回调，可不加
							document.getElementById('OdPopLayer-microTextInput-upVideoBtn').className = 'OdPopLayer';
							videoUploadReload(uploader);
							setTimeout(function() {
								document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upVideoBtn'));
							}, 200);
						}
					});
				};
				videoBox.appendChild(speedDom);
				videoBox.appendChild(cancelBtn);
				popContent.appendChild(videoBox);
			},
			closeCallBack: function() { //关闭回调
				videoUploadReload(uploader);
			}
		});
		uploader.disableBrowse(true);
		browseDisable('i');
	};
	//视频上传过程-progress
	function videoProgress(uploader, file) {
		document.getElementById('microTextUploadVideoSpeed').getElementsByTagName('em')[0].innerText = plupload.formatSize(file.speed).toUpperCase();
		var percentage = file.loaded / file.size * 100;
		if (file.status !== plupload.DONE && percentage === 100) {
			percentage = 99;
		}
		percentage = percentage.toFixed(1);
		document.getElementById('videoUploadPercentage').innerText = percentage + '%';
		document.getElementById('videoUploadProgress').style.width = percentage + '%';
	};
	//视频上传-loaded
	function videoLoaded(uploader, file, info) {
		var div = document.createElement('div');
		info = eval('(' + info.response + ')');
		div.id = "upload-video-info";
		div.style.width = '245px';
		div.style.height = '138px';
		div.style.marginTop = '10px';
		div.style.background = 'url(/images/transcoding.png) no-repeat';
		div.setAttribute('fsize', info.fsize);
		div.setAttribute('w', info.w);
		div.setAttribute('h', info.h);
		div.setAttribute('hash', info.hash);
		div.setAttribute('mime', info.mimeType);
		div.setAttribute('time', parseInt(info.duration * 1000));
		document.getElementById('OdPopLayer-microTextInput-upVideoBtn').querySelector('.content').innerHTML = '';
		document.getElementById('OdPopLayer-microTextInput-upVideoBtn').querySelector('.content').appendChild(div);
	};
	//上传视频/图片按钮切换重置
	function browseDisable(res) {
		if (res == 'v' && document.getElementById('microTextInput-upVideoBtn')) {
			videoUpload.disableBrowse(true);
			document.getElementById('microTextInput-upVideoBtn').onclick = function(e) {
				Od.Alert({
					html: '是否取消上传图片？', //弹出框html
					cancelBtn: true, //是否显示取消按钮，默认false，可不加。
					target: Od.Target(e), //触发此事件按钮
					callBack: function() { //点击确定的回调，可不加
						document.getElementById('OdPopLayer-microTextInput-upImgBtn').className = 'OdPopLayer';
						videoUpload.disableBrowse(false);
						imageUpload.destroy();
						document.getElementById('microTextInput-upVideoBtn').onclick = '';
						setTimeout(function() {
							imageUpload = Od.imageUpload({
								uploader: this,
								id: 'microTextInput-upImgBtn',
								singleSelect: multiFlag,
								fileAdd: function(up, files) {
									imgAdd(up, files);
								},
								fileLoaded: function(up, file, info) {
									imgLoaded(up, file, info);
								},
								fileComplete: function() {
									imgCompleteFunc(this.uploader);
								}
							});
							document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upImgBtn'));
						}, 200);
					}
				});
			}
		}
		if (res == 'i' && document.getElementById('microTextInput-upImgBtn')) {
			imageUpload.disableBrowse(true);
			document.getElementById('microTextInput-upImgBtn').onclick = function(e) {
				Od.Alert({
					html: '是否取消上传视频？', //弹出框html
					cancelBtn: true, //是否显示取消按钮，默认false，可不加。
					target: Od.Target(e), //触发此事件按钮
					callBack: function() { //点击确定的回调，可不加
						if (document.getElementById('microTextInput-upVideoBtn')) {
							document.getElementById('OdPopLayer-microTextInput-upVideoBtn').className = 'OdPopLayer';
						}
						imageUpload.disableBrowse(false);
						videoUpload.destroy();
						setTimeout(function() {
							videoUpload = Od.videoUpload({
								uploader: this,
								id: 'microTextInput-upVideoBtn',
								fileAdd: function(up, files) {
									videoAdd(up, files)
								},
								fileProgress: function(up, file) {
									videoProgress(up, file);
								},
								fileLoaded: function(up, file, info) {
									videoLoaded(up, file, info);
								},
								upError: function() {
									videoUploadError(uploader);
								}
							});
							document.getElementById('microTextInput-upVideoBtn') && document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upVideoBtn'));
							document.getElementById('microTextInput-upImgBtn').onclick = '';
						}, 200);
					}
				});
			}
		}
		if (res == 'all') {
			if (document.getElementById('microTextInput-upVideoBtn')) {
				document.getElementById('microTextInput-upVideoBtn').onclick = '';
			}
			document.getElementById('microTextInput-upImgBtn').onclick = '';
			imageUpload.destroy();
			imageUpload = Od.imageUpload({
				uploader: this,
				id: 'microTextInput-upImgBtn',
				singleSelect: multiFlag,
				fileAdd: function(up, files) {
					imgAdd(up, files);
				},
				fileLoaded: function(up, file, info) {
					imgLoaded(up, file, info);
				},
				fileComplete: function() {
					imgCompleteFunc(this.uploader);
				}
			});
			if (videoUpload) {
				videoUpload.destroy();
			}
			if (document.getElementById('microTextInput-upVideoBtn')) {
				videoUpload = Od.videoUpload({
					uploader: this,
					id: 'microTextInput-upVideoBtn',
					fileAdd: function(up, files) {
						videoAdd(up, files)
					},
					fileProgress: function(up, file) {
						videoProgress(up, file);
					},
					fileLoaded: function(up, file, info) {
						videoLoaded(up, file, info);
					},
					upError: function() {
						videoUploadError(uploader);
					}
				});
			}

		}
	};
	//发布帖子
	function pubSnsThread() {
		var textareaVal = document.getElementById("microTextInput-textarea").value;
		var reg = /(\[\$)([\u4e00-\u9fa5,a-z]*)(\$\])/g;
		var aaa = textareaVal.match(reg);
		if (aaa != null) {
			for (var i = 0; i < aaa.length; i++) {
				textareaVal = textareaVal.replace(aaa[i], faceDic[aaa[i]]);
			}
		}
		var communityJson = [];
		for (s in communitySelect) {
			communityJson.push(communitySelect[s].id);
		}
		pubThread(textareaVal, communityJson.join(','));
	}
	//发布微文
	function pubSns() {
		pubFlag = false;
		var imageJson = [],
			videoJson = [],
			communityJson = [],
			content = document.getElementById('microTextInput-textarea').value;
		//圈子数据
		for (s in communitySelect) {
			communityJson.push(communitySelect[s].id);
		}
		//图片数据
		if (document.getElementById('microTextImgSort')) {
			var lists = document.getElementById('microTextImgSort').getElementsByTagName('li');
			for (var i = 0, len = lists.length; i < len; i++) {
				if (lists[i].id != 'dummy' && lists[i].id != 'dragable' && lists[i].getAttribute('hash')) {
					imageJson.push({
						size: lists[i].getAttribute('fsize'),
						mime: lists[i].getAttribute('mime'),
						width: lists[i].getAttribute('w'),
						description: '',
						sort: i + 1,
						type: 2,
						hash: lists[i].getAttribute('hash'),
						url: lists[i].getAttribute('url'),
						height: lists[i].getAttribute('h')
					});
				}
			}
		}
		//视频数据
		if (document.getElementById('upload-video-info')) {
			var microVideo = document.getElementById('upload-video-info');
			videoJson.push({
				size: microVideo.getAttribute('fsize'),
				mime: microVideo.getAttribute('mime'),
				width: microVideo.getAttribute('w'),
				description: '',
				time: microVideo.getAttribute('time'),
				type: 3,
				hash: microVideo.getAttribute('hash'),
				url: microVideo.getAttribute('hash'),
				height: microVideo.getAttribute('h')
			});
		}
		var atJson = '';
		var atJsonCookie = '';
		//@/#列表
		var atReg = /(\@[^@]*?)([^\:]\s|\:|\：|$)/g;
		var atList = content.match(atReg);
		if (atList) {
			var atTempList = [];
			for (var i = 0, len = atList.length; i < len; i++) {
				atList[i] = atList[i].replace('@', '');
				atList[i] = atList[i].replace(/\s/g, '');
				atList[i] = atList[i].replace(/\:/g, '');
				atList[i] = atList[i].replace(/\：/g, '');
				if (atTempList.indexOf(atList[i]) < 0) {
					if (atList[i] != '') {
						if (atTempList.length <= 0) {
							atJson = atList[i];
							atJsonCookie = encodeURIComponent(atList[i]);
						} else {
							atJson = atJson + ',' + atList[i];
							atJsonCookie = atJsonCookie + ',' + encodeURIComponent(atList[i]);
						}

					}
					atTempList.push(atList[i]);
				}
			}
		}
		var topicJson = '';
		var topicJsonCookie = '';
		var topicReg = /(#)([\u4e00-\u9fa5,A-Za-z0-9]*)(#)/g;
		var topicList = content.match(topicReg);
		if (topicList) {
			var topicTempList = [];
			for (var j = 0, len = topicList.length; j < len; j++) {
				topicList[j] = topicList[j].replace(topicReg, '$2');
				if (topicTempList.indexOf(topicList[j]) < 0) {
					if (topicList[j] != '') {
						if (topicTempList.length <= 0) {
							topicJson = topicList[j];
							topicJsonCookie = encodeURIComponent(topicList[j]);
						} else {
							topicJson = topicJson + ',' + topicList[j];
							topicJsonCookie = topicJsonCookie + ',' + encodeURIComponent(topicList[j]);
						}
						topicTempList.push(topicList[j]);
					}
				}
			}
		}
		content = content.replace(/(^\s*)|(\s*$)/g, "");
		content = Od.TransTextToCode(content);
		content = encodeURIComponent(content);
		content = content.replace(/\n/g, '<br>');
		if (document.getElementById('microTextInputCount').innerHTML.length > 0) {
			Od.Alert({
				html: '微文内容不得超过1000字',
				callBack: function() {
					pubFlag = true;
				}
			});
		} else {
			if (content.length <= 0 && imageJson.length <= 0 && videoJson.length <= 0) {
				Od.Alert({
					html: '请输入内容',
					callBack: function() {
						pubFlag = true;
					}
				});
			} else {
				if (content.length <= 0) {
					if (imageJson.length > 0) {
						content = '分享图片';
					}
					if (videoJson.length > 0) {
						content = '发布视频';
					}
				}
				var dataObj = microTextRes && microTextRes.isDiscuss ? {
					'imagelist': JSON.stringify(imageJson),
					'autodiscussid': microTextRes.autoDiscussId,
					'content': content,
					'communityidlist': communityJson.join(',')
				} : {
					'videolist': JSON.stringify(videoJson),
					'imagelist': JSON.stringify(imageJson),
					'atlist': JSON.stringify(atJson),
					'source': 2,
					'content': content,
					'communityidlist': communityJson.join(',')
				};
				Od.Ajax({
					method: 'post', //方法
					url: postUrl, //接口地址
					asyc: false, //是否为异步
					data: dataObj,
					success: function(res) { //请求成功
						//at人计入cookie
						if (res.code == 1) {
							if (atJsonCookie) {
								var atlist = document.cookie;
								atlist = atlist.match(/(atlist\=\[)(.*?)(\])/g);
								var atExpdate = new Date(); //初始化时间
								atExpdate.setTime(atExpdate.getTime() + 1000 * 60 * 60 * 24 * 365); //一年有效
								if (atlist) {
									atlist = atlist[0].replace('atlist=[', '').replace(']', '');
									atlist = atJsonCookie + ',' + atlist;
								} else {
									atlist = atJsonCookie;
								}
								document.cookie = 'atlist=[' + atlist + '];expires=' + atExpdate.toGMTString() + ';path=/';
							}
							if (topicJsonCookie) {
								var topicExpdate = new Date(); //初始化时间
								topicExpdate.setTime(topicExpdate.getTime() + 1000 * 60 * 60 * 24 * 182); //一年有效
								var topiclist = document.cookie;
								topiclist = topiclist.match(/(topiclist\=\[")(.*?)(\])/g);
								if (topiclist) {
									topiclist = topiclist[0].replace('topiclist=[', '').replace(']', '');
									topiclist = topicJsonCookie + ',' + topiclist;
								} else {
									topiclist = topicJsonCookie;
								}
								document.cookie = 'topiclist=[' + topiclist + '];expires=' + topicExpdate.toGMTString() + ';path=/';
							}
							// Od.Alert({
							// 	html: '发布成功',
							// 	callBack: function() {
							// 		pubFlag = true;
							// 		document.getElementById('microTextInput-textarea').value = '';
							// 		if (document.getElementById('OdPopLayer-microTextInput-upImgBtn')) {
							// 			document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upImgBtn'));
							// 		}
							// 		if (document.getElementById('OdPopLayer-microTextInput-upVideoBtn')) {
							// 			document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upVideoBtn'));
							// 		}
							// 		document.body.removeChild(document.getElementById('microTextInput'));
							// 		document.body.removeChild(document.getElementById('OdWindowMask'));
							// 	}
							// });
							var successLayer = document.createElement('div');
							successLayer.className = 'pub-success';
							successLayer.style.width = document.getElementById('microTextInput').querySelector('.input-area').offsetWidth - 2 + 'px';
							successLayer.style.height = document.getElementById('microTextInput').querySelector('.input-area').offsetHeight - 2 + 'px';
							successLayer.style.lineHeight = document.getElementById('microTextInput').querySelector('.input-area').offsetHeight + 'px';
							successLayer.style.top = Od.Top(document.getElementById('microTextInput').querySelector('.input-area')) + 2 + 'px';
							successLayer.style.left = Od.Left(document.getElementById('microTextInput').querySelector('.input-area')) + 2 + 'px';
							successLayer.innerHTML = '<i></i>发布成功'
							successLayer.style.opacity = 0;
							document.body.appendChild(successLayer);
							setTimeout(function() {
								successLayer.style.opacity = 1;
							}, 20);
							setTimeout(function() {
								document.body.removeChild(document.getElementById('microTextInput'));
								document.body.removeChild(document.getElementById('OdWindowMask'));
								document.body.removeChild(successLayer);
								pubFlag = true;
								if (document.getElementById('OdPopLayer-microTextInput-upImgBtn')) {
									document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upImgBtn'));
								}
								if (document.getElementById('OdPopLayer-microTextInput-upVideoBtn')) {
									document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upVideoBtn'));
								}
								if (microTextRes && microTextRes.callBack) {
									microTextRes.callBack(res);
								}
							}, 720);
						} else {
							Od.Alert({
								html: '发布失败',
								callBack: function() {
									pubFlag = true;
								}
							});
						}
					},
					error: function() { //请求接口失败
						Od.Alert({
							html: '请求接口失败',
							callBack: function() {
								pubFlag = true;
							}
						});
					}
				});
			}
		}
	};
	//	if(isLoadCommunity != undefined && isLoadCommunity) {
	//		microAddCommunity();
	//		return false;
	//	}
	var flags = false;
	//弹出编辑器浮层
	var microTextInputWindow = Od.Window({
		id: 'microTextInput',
		w: 800,
		title: microTextRes && microTextRes.isDiscuss ? '发布观点' : '发布内容', //弹出窗口标题，可不加，不加默认文案“老司机-有趣的汽车社区”
		html: buildHtml(),
		openCallBack: function() { //打开窗口回调
			//			if(communityDataArr.length == 0) {
			//	microAddCommunity();
			//			}
			//microAddCommunity();
			//			microDetailsAddCommunity();
			if (isOnce) {
				var loading = document.createElement('div');
				loading.style.position = 'absolute';
				loading.style.top = '150px';
				loading.style.left = '360px';
				loading.style.textAlign = 'center';
				loading.className = 'micro-loading';
				loading.innerHTML = '<img src="/new_web/static/images/loading.gif"/>';
				document.querySelector('.microTextInput-community').appendChild(loading);
				microAddCommunity();
				microDetailsAddCommunity();
			}
			Od.Textarea({
				id: 'microTextInput-textarea', //textarea id
				listZindex: 1002,
				width: 728,
				maxHeight: 300, //最大高度，超过此高度显示滚动条
				minHeight: 90, //最小高度，默认高度
				maxCharCount: 1000,
				fontSize: 14, //字体大小
				lineHeight: 18, //行高
				userId: 1, //登录用户id
				atUrl: '/api/user/follow', //关注人列表接口
				topicUrl: '/api/getTopicList', //话题列表接口
				countTarget: document.getElementById('microTextInputCount'), //显示计数元素
				pubFunc: function() {
					if (pubFlag) {
						if (microTextRes != undefined && microTextRes.isThread) {
							pubSnsThread();
						} else {
							pubSns();
						}
					}
				}
			});
			imageUpload = Od.imageUpload({
				uploader: this,
				id: 'microTextInput-upImgBtn',
				singleSelect: multiFlag,
				fileAdd: function(up, files) {
					imgAdd(up, files);
				},
				fileLoaded: function(up, file, info) {
					imgLoaded(up, file, info);
				},
				fileComplete: function() {
					imgCompleteFunc(this.uploader);
				}
			});
			if (document.getElementById('microTextInput-upVideoBtn')) {
				videoUpload = Od.videoUpload({
					uploader: this,
					id: 'microTextInput-upVideoBtn',
					fileAdd: function(up, files) {
						videoAdd(up, files)
					},
					fileProgress: function(up, file) {
						videoProgress(up, file);
					},
					fileLoaded: function(up, file, info) {
						videoLoaded(up, file, info);
					}
				});
			}
		},
		closeAttentionHtml: '是否放弃发布内容？',
		closeAttention: function(btn) {
			if (document.getElementById('microTextInput-textarea').value == '' && !document.getElementById('OdPopLayer-microTextInput-upImgBtn') && !document.getElementById('OdPopLayer-microTextInput-upVideoBtn')) {
				flags = false;
			} else {
				flags = true;
			}
			return flags;
		},
		closeCallBack: function() {
			if (document.getElementById('OdPopLayer-microTextInput-upImgBtn')) {
				document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upImgBtn'));
			}
			if (document.getElementById('OdPopLayer-microTextInput-upVideoBtn')) {
				document.body.removeChild(document.getElementById('OdPopLayer-microTextInput-upVideoBtn'));
			}
		}
	});
};